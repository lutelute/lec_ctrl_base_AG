<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ•ã‚£ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰åˆ¶å¾¡ã«ã‚ˆã‚‹å¤–ä¹±æŠ‘åˆ¶</title>
    <style>
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
            background-color: #f9f9f9;
            color: #333;
        }

        h1 {
            color: #007bff;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }

        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        canvas {
            border: 1px solid #ddd;
            width: 100%;
            height: 350px;
            margin-bottom: 20px;
            background-color: #fff;
        }

        .controls {
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
            background: #eee;
            padding: 15px;
            border-radius: 5px;
        }

        button {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: bold;
        }

        button:hover {
            background-color: #c82333;
        }

        .switch {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }

        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 10px;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <h1>ç¬¬8ç« : ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯(FB) vs ãƒ•ã‚£ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰(FF)</h1>
    <p>ä¸€å®šé€Ÿåº¦ã§èµ°ã‚‹è»Šï¼ˆã‚¯ãƒ«ãƒ¼ã‚ºã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼‰ã«ã€æ€¥ãªå‚é“ï¼ˆå¤–ä¹±ï¼‰ãŒç›´æ’ƒã—ãŸçŠ¶æ³ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¾ã™ã€‚<br>
        FFåˆ¶å¾¡ãŒãªã„ã¨é€Ÿåº¦ãŒè½ã¡ã¦ã‹ã‚‰æˆ»ã‚Šã¾ã™ãŒã€FFåˆ¶å¾¡ãŒã‚ã‚‹ã¨å‚é“ã‚’æ¤œçŸ¥ã—ã¦äº‹å‰ã«ã‚¢ã‚¯ã‚»ãƒ«ã‚’è¸ã¿ã€é€Ÿåº¦ä½ä¸‹ã‚’é˜²ã’ã¾ã™ã€‚</p>

    <div class="container">
        <div class="chart-legend">
            <span style="color: blue;">é’: é€Ÿåº¦ (å‡ºåŠ› y)</span>
            <span style="color: orange;">æ©™: å¤–ä¹± (å‚é“ d)</span>
            <span style="color: green;">ç·‘: ç›®æ¨™é€Ÿåº¦ (r)</span>
        </div>
        <canvas id="simCanvas" width="900" height="350"></canvas>

        <div class="controls">
            <button id="addDisturbanceBtn">ğŸ’¥ å¤–ä¹±ï¼ˆå‚é“ï¼‰æŠ•å…¥ï¼</button>
            <div class="switch">
                <input type="checkbox" id="ffToggle">
                <label for="ffToggle">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰åˆ¶å¾¡ (FF) ã‚’æœ‰åŠ¹ã«ã™ã‚‹</label>
            </div>
            <button id="resetBtn" style="background-color: #6c757d;">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        <p style="text-align: center; color: #666; font-size: 0.9em;">â€» FBåˆ¶å¾¡ã¯å¸¸ã«æœ‰åŠ¹ã§ã™ (PIåˆ¶å¾¡)ã€‚FFæœ‰åŠ¹æ™‚ã¯ã€å¤–ä¹±æŠ•å…¥ã¨åŒæ™‚ã«è£œæ­£ã‚’è¡Œã„ã¾ã™ã€‚</p>
    </div>

    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        const ffToggle = document.getElementById('ffToggle');

        // Simulation params
        let time = 0;
        const dt = 0.05;
        let y = 0; // Velocity
        let r = 50; // Reference speed
        let d = 0; // Disturbance (Slope)
        let I_err = 0; // Integral error

        // History for plotting
        const maxHistory = 400;
        let historyY = new Array(maxHistory).fill(0);
        let historyR = new Array(maxHistory).fill(50);
        let historyD = new Array(maxHistory).fill(0);

        // System: 1st order lag for car dynamics
        // T v_dot + v = K u - d
        const T = 2.0;
        const K = 1.0;

        // Controller (PI)
        const Kp = 2.0;
        const Ki = 0.5;

        let lastDisturbanceTime = -999;

        function update() {
            // Error
            const e = r - y;
            I_err += e * dt;

            // FB Control Input
            let u_fb = Kp * e + Ki * I_err;

            // FF Control Input
            // Ideal FF: u_ff = (1/K) * d
            // Only if FF is enabled
            let u_ff = 0;
            if (ffToggle.checked) {
                u_ff = (1.0 / K) * d;
            }

            const u = u_fb + u_ff;

            // System Update
            // T y_dot + y = K u - d*K (assume disturbance enters like load torque)
            // y_dot = (K*u - K*d - y) / T  (Let's assume d is equivalent input disturbance for simplicity: K*d)
            // Just use: T y_dot + y = K(u - d) 
            const y_dot = (K * (u - d) - y) / T;

            y += y_dot * dt;
            time += dt;

            // Shift and push history
            historyY.shift(); historyY.push(y);
            historyR.shift(); historyR.push(r);
            historyD.shift(); historyD.push(d * 10); // Scale up for visibility

            // Auto remove disturbance after some time
            if (time - lastDisturbanceTime > 5.0 && d > 0) {
                d *= 0.95; // Decay
                if (d < 0.1) d = 0;
            }
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw Grid/Axes
            //...

            const h = canvas.height;
            const w = canvas.width;

            // Scale
            const maxVal = 80;
            const minVal = -20;
            const range = maxVal - minVal;

            function toY(val) {
                return h - ((val - minVal) / range) * h;
            }

            function plotLine(data, color, width = 2) {
                ctx.beginPath();
                ctx.strokeStyle = color;
                ctx.lineWidth = width;
                data.forEach((val, i) => {
                    const x = (i / (maxHistory - 1)) * w;
                    const yPos = toY(val);
                    if (i === 0) ctx.moveTo(x, yPos);
                    else ctx.lineTo(x, yPos);
                });
                ctx.stroke();
            }

            // Draw Target R
            plotLine(historyR, 'green', 2);
            // Draw Disturbance D
            plotLine(historyD, 'orange', 2);
            // Draw Output Y
            plotLine(historyY, 'blue', 3);

            // Labels
            ctx.fillStyle = '#666';
            ctx.fillText("Time ->", w - 50, h - 5);
        }

        function loop() {
            update();
            draw();
            requestAnimationFrame(loop);
        }

        document.getElementById('addDisturbanceBtn').onclick = () => {
            d = 20.0; // Sudden slope!
            lastDisturbanceTime = time;
        };

        document.getElementById('resetBtn').onclick = () => {
            y = 0; I_err = 0; d = 0; u = 0;
            historyY.fill(0);
            historyR.fill(50);
            historyD.fill(0);
        };

        loop();
    </script>
</body>

</html>