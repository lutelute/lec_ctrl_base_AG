<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ラウスの安定判別法 計算機</title>
    <style>
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            background-color: #f9f9f9;
            color: #333;
        }

        h1 {
            color: #007bff;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .input-area {
            margin-bottom: 20px;
        }

        input[type="text"] {
            width: 100%;
            padding: 10px;
            font-size: 1.1em;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            padding: 10px 20px;
            font-size: 1em;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }

        button:hover {
            background-color: #0056b3;
        }

        .result-area {
            margin-top: 30px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        th {
            background-color: #f1f3f5;
        }

        .first-col {
            font-weight: bold;
        }

        .unstable-sign {
            color: red;
            background-color: #ffeef0;
        }

        .stable {
            color: green;
            font-weight: bold;
            font-size: 1.2em;
        }

        .unstable {
            color: red;
            font-weight: bold;
            font-size: 1.2em;
        }
    </style>
</head>

<body>
    <h1>第9章: ラウスの安定判別法</h1>
    <p>特性方程式 $a_n s^n + a_{n-1} s^{n-1} + \dots + a_0 = 0$ の係数を入力して、安定性を判別します。</p>

    <div class="container">
        <div class="input-area">
            <label>係数 ($a_n, a_{n-1}, \dots, a_0$ の順にカンマ区切り):</label>
            <input type="text" id="coeffInput" value="1, 2, 3, 4, 5" placeholder="例: 1, 6, 11, 6">
            <button onclick="calculate()">判別実行</button>
        </div>

        <div id="result" class="result-area" style="display:none;">
            <h3>結果: <span id="statusText"></span></h3>
            <p id="detailText"></p>
            <h4>ラウス表</h4>
            <table id="routhTable"></table>
        </div>

        <div style="margin-top:20px; font-size:0.9em; color:#666;">
            <strong>ヒント:</strong><br>
            <ul>
                <li>係数は高次の項から順に入力してください。</li>
                <li>すべての係数が正でない場合、計算するまでもなく不安定です（必要条件不成立）。</li>
                <li>ラウス表の第1列（一番左の数値列）の符号変化回数が、不安定極（右半平面極）の数と一致します。</li>
            </ul>
        </div>
    </div>

    <script>
        function calculate() {
            const input = document.getElementById('coeffInput').value;
            const coeffs = input.split(/[,、\s]+/).map(parseFloat).filter(n => !isNaN(n));

            if (coeffs.length < 2) {
                alert("係数を2つ以上入力してください。");
                return;
            }

            const resultDiv = document.getElementById('result');
            const statusText = document.getElementById('statusText');
            const detailText = document.getElementById('detailText');
            const table = document.getElementById('routhTable');

            resultDiv.style.display = 'block';
            table.innerHTML = "";

            // Check necessary condition
            const allPositive = coeffs.every(c => c > 0);
            const allNegative = coeffs.every(c => c < 0);

            if (!allPositive && !allNegative) {
                statusText.textContent = "不安定 (Unstable)";
                statusText.className = "unstable";
                detailText.textContent = "必要条件（係数がすべて同符号）を満たしていません。";
                // Still show table for educational purpose? Or stop? Let's show table.
            }

            // Construct Routh Array
            const n = coeffs.length - 1; // Degree
            const rows = [];

            // First two rows
            let row0 = [];
            let row1 = [];
            for (let i = 0; i < coeffs.length; i++) {
                if (i % 2 === 0) row0.push(coeffs[i]);
                else row1.push(coeffs[i]);
            }
            rows.push(row0);
            rows.push(row1);

            // Remaining rows
            for (let k = 2; k <= n; k++) {
                const prev1 = rows[k - 1];
                const prev2 = rows[k - 2];
                const newRow = [];

                // pivot is prev1[0]
                const pivot = prev1[0];

                if (Math.abs(pivot) < 1e-10) {
                    // Zero pivot case - specialized handling needed (usually replace with epsilon)
                    // Simple handling for demo:
                    newRow.push(0); // This will likely break next steps or indicate boundary
                } else {
                    // b1 = (a1*a2 - a0*a3) / a1  (using formula indices)
                    // b_i = (prev1[0]*prev2[i+1] - prev2[0]*prev1[i+1]) / prev1[0]
                    // careful with indices length
                    for (let j = 0; j < prev2.length - 1; j++) {
                        const val1 = (j + 1 < prev2.length) ? prev2[j + 1] : 0;
                        const val2 = (j + 1 < prev1.length) ? prev1[j + 1] : 0;
                        const val = (pivot * val1 - prev2[0] * val2) / pivot;
                        newRow.push(val);
                    }
                }
                if (newRow.length === 0) newRow.push(0); // End of array
                rows.push(newRow);
            }

            // Render Table
            let signChanges = 0;
            let lastSign = Math.sign(rows[0][0]);

            rows.forEach((row, idx) => {
                const tr = document.createElement('tr');

                // Header cell (s^k)
                const th = document.createElement('td');
                th.textContent = `s^${n - idx}`;
                th.style.fontWeight = "bold";
                tr.appendChild(th);

                row.forEach((val, cIdx) => {
                    const td = document.createElement('td');
                    td.textContent = val.toFixed(4);
                    // Check first col sign
                    if (cIdx === 0) {
                        td.className = "first-col";
                        const currentSign = Math.sign(val);
                        if (currentSign !== 0 && currentSign !== lastSign) {
                            signChanges++;
                            lastSign = currentSign;
                            td.classList.add("unstable-sign");
                        }
                    }
                    tr.appendChild(td);
                });
                table.appendChild(tr);
            });

            if (signChanges === 0 && (allPositive || allNegative)) {
                statusText.textContent = "安定 (Stable)";
                statusText.className = "stable";
                detailText.textContent = "第1列の符号変化がなく、必要条件も満たしています。すべての極は左半平面にあります。";
            } else {
                statusText.textContent = "不安定 (Unstable)";
                statusText.className = "unstable";
                detailText.textContent = `不安定極の数: ${signChanges}個 (第1列の符号変化回数)`;
            }
        }
    </script>
</body>

</html>